name: Create verification issue for reviewers

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, review_requested]

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  create-verification-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Collect PR data and create issue
        id: create_issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info("Nessuna PR trovata.");
              return;
            }

            const reviewers = (pr.requested_reviewers || []).map(r => r.login);
            if (reviewers.length === 0) {
              core.info("Nessun verificatore assegnato → nessuna issue creata.");
              return;
            }

            const { owner, repo } = context.repo;

            const issueTitle = `Verifica richiesta per PR #${pr.number}: ${pr.title}`;
            const issueBody = `Eseguire l'attività di verifica secondo il processo di verifica presente nelle norme di progetto del gruppo`;

            const newIssue = await github.rest.issues.create({
              owner,
              repo,
              title: issueTitle,
              body: issueBody,
              assignees: reviewers
            });

            core.setOutput("issue_url", newIssue.data.html_url);
            core.setOutput("issue_id", newIssue.data.node_id);

      - name: Add issue to GitHub Project (v2)
        if: ${{ steps.create_issue.outputs.issue_id != '' }}
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/orgs/BitByBit-SWE/projects/2
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          labeled: verifica
